<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png"><link rel="icon" href="/img/icon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="AprilBlank"><meta name="keywords" content="qt,QSqlDatabase,数据库"><meta name="description" content="qt系列个人使用教程"><meta property="og:type" content="article"><meta property="og:title" content="Qt 系列（七）——数据库"><meta property="og:url" content="http://www.aprilblank.top/qt/database.html"><meta property="og:site_name" content="AprilBlank&#39;s Blog"><meta property="og:description" content="qt系列个人使用教程"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.aprilblank.top/qt/database/1.png"><meta property="og:image" content="http://www.aprilblank.top/qt/database/2.png"><meta property="og:image" content="http://www.aprilblank.top/qt/database/3.png"><meta property="og:image" content="http://www.aprilblank.top/qt/database/4.png"><meta property="article:published_time" content="2022-07-25T06:50:55.000Z"><meta property="article:modified_time" content="2022-07-25T06:50:55.000Z"><meta property="article:author" content="AprilBlank"><meta property="article:tag" content="qt"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://www.aprilblank.top/qt/database/1.png"><title>Qt 系列（七）——数据库 - AprilBlank&#39;s Blog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/april-css.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.aprilblank.top",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:"4ddccc882732648d4843e019139cdf8d",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"s5z5TyRMaBchMy3ctLecCTVu-gzGzoHsz",app_key:"gDTvr3YyUBoiuEkLYjSdwggm",server_url:"https://s5z5tyrm.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>if(!Fluid.ctx.dnt){var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4ddccc882732648d4843e019139cdf8d";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()}</script><meta name="generator" content="Hexo 5.4.2"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>AprilBlank</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Qt 系列（七）——数据库"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-07-25 14:50" pubdate>2022年7月25日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i>5.8k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i>29 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Qt 系列（七）——数据库</h1><div class="markdown-body"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>数据存储这块儿不管是B/S还是C/S都是少不了的，而qt中直接有现成的链接数据库的类，当然适配的应该不至于跟Orm一样花里胡哨，常规的<strong>Sqllite，SqlServer，Mysql</strong>啥的是没问题的。</p><h3 id="Qt连接数据库"><a href="#Qt连接数据库" class="headerlink" title="Qt连接数据库"></a>Qt连接数据库</h3><p>qt支持的数据库个人常用的驱动名称如下：</p><table><thead><tr><th>驱动类别</th><th>对应数据库</th></tr></thead><tbody><tr><td>QSQLITE</td><td>SQLLITE3以上</td></tr><tr><td>QODBC</td><td>SQLSERVER</td></tr><tr><td>QMYSQL</td><td>MYSQL</td></tr></tbody></table><h4 id="配置工程"><a href="#配置工程" class="headerlink" title="配置工程"></a>配置工程</h4><p>首先来看下如何配置工程，QCreator的话在pro文件中找到<strong>QT +=</strong> 这句。</p><figure class="highlight qt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs qt">QT += core gui sql<br></code></pre></td></tr></table></figure><p>vs的话，类似，在工程属性页对应下图配置。</p><p><img src="./database/1.png" srcset="/img/loading.gif" lazyload alt="配置"></p><h4 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h4><p>接下来就可以来实现连接了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// .h</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QString&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QtSql/QSqlDatabase&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QtSql/QtSql&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QtSql/QSqlQuery&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CSqlLiteManager</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">CSqlLiteManager</span>();<br>    ~<span class="hljs-built_in">CSqlLiteManager</span>();<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">connectToDb</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isConnected</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    QSqlDatabase m_connect;<br>    <span class="hljs-type">bool</span> m_isConnected = <span class="hljs-literal">false</span>;<br>&#125;;<br><br><br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// .cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CSqlLiteManager::connectToDb</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (QSqlDatabase::<span class="hljs-built_in">contains</span>(<span class="hljs-string">&quot;qt_sql_default_connection&quot;</span>))<br>    &#123;<br>        m_connect = QSqlDatabase::<span class="hljs-built_in">database</span>(<span class="hljs-string">&quot;qt_sql_default_connection&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        m_connect = QSqlDatabase::<span class="hljs-built_in">addDatabase</span>(<span class="hljs-string">&quot;QSQLITE&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!m_connect.<span class="hljs-built_in">isValid</span>())<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;connect sqllite failed&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    m_connect.<span class="hljs-built_in">setDatabaseName</span>(<span class="hljs-string">&quot;test.db&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!m_connect.<span class="hljs-built_in">open</span>())<br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;open sqllite failed&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>调用这个类然后运行程序，不出意外的话会有如下提示（当然如果已经配置了环境变量之类的可能会直接成功）：</p><p><img src="./database/2.png" srcset="/img/loading.gif" lazyload alt="未加载sqllite"></p><p>找到qt类库目录，然后从plugins拷走<strong>sqldrivers</strong>到运行程序目录下，对应层级设置好（个人习惯在exe同层新建plugins然后放置对应qt的插件库）。</p><p>在main.cpp中添加读取插件库的方法。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">QApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span></span>;<br>    QString strLibPath = a.<span class="hljs-built_in">applicationDirPath</span>();<br>    strLibPath += <span class="hljs-string">&quot;/plugins/&quot;</span>;<br>    a.<span class="hljs-built_in">addLibraryPath</span>(strLibPath);<br>    QtDemo w;<br>    w.<span class="hljs-built_in">show</span>();<br>    <span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>再运行程序就可以看到对应目录下有个<strong>test.db</strong>这个数据库。</p><h4 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h4><p>新建的数据库里肯定都是空的，所以需要来张表操作下，可以通过数据库管理工具（SQLLite Expert啊，Navicat之类的），这里用的sqllite就直接建个表了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CSqlLiteManager::createTable</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    QSqlQuery query;<br>    query.<span class="hljs-built_in">exec</span>(<span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;select count(1) from sqlite_master where type=&#x27;table&#x27; and name=&#x27;person&#x27;&quot;</span>));<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">next</span>())<br>    &#123;<br>        <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">value</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">toInt</span>() == <span class="hljs-number">0</span>)<br>        &#123;<br>            QString create_sql = <span class="hljs-string">&quot;create table person (id integer primary key autoincrement, number varchar(10), name varchar(20), utype int, addtime datetime default (datetime(&#x27;now&#x27;, &#x27;localtime&#x27;)))&quot;</span>;<br>            query.<span class="hljs-built_in">prepare</span>(create_sql);<br>            <span class="hljs-keyword">if</span> (!query.<span class="hljs-built_in">exec</span>())<br>            &#123;<br>                std::cout &lt;&lt; <span class="hljs-string">&quot;create table failed  &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; endl;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;select table failed  &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; std::endl;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-warning"><p>通过<strong>QSqlQuery.lastError()</strong> 可以获取到执行的错误信息，方便排查问题。</p></div><p>运行程序，然后我们通过个工具来看下是否建表完成。</p><p><img src="./database/3.png" srcset="/img/loading.gif" lazyload alt="建表完成"></p><h4 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h4><blockquote><p>所有的数据相关离不开增删改查，crud工程师的必备技能。</p></blockquote><p>这部分基本上直接上代码了，对应的扩展可以自行臆想。</p><h5 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CSqlLiteManager::insertData</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br>    QSqlQuery query;<br>    QString sql = <span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;insert into person (%1) values(&#x27;%2&#x27;,&#x27;%3&#x27;,%4,&#x27;%5&#x27;)&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;`number`,`name`,`utype`,`addtime`&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;100001&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;test01&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-number">1</span>)<br>        .<span class="hljs-built_in">arg</span>(QDateTime::<span class="hljs-built_in">currentDateTime</span>().<span class="hljs-built_in">toString</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">exec</span>(sql))<br>    &#123;<br>        ret = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;insertData error: &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CSqlLiteManager::updateData</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br>    QSqlQuery query;<br>    QString sql = <span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;update person set `name`=&#x27;test0002&#x27; where id=%1&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">exec</span>(sql))<br>    &#123;<br>        ret = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;updateData error: &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CSqlLiteManager::deleteData</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br>    QSqlQuery query;<br>    QString sql = <span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;delete from person where id=%1&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">exec</span>(sql))<br>    &#123;<br>        ret = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;deleteData error: &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::vector&lt;DbViewItem&gt; <span class="hljs-title">CSqlLiteManager::getData</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    std::vector&lt;DbViewItem&gt; data;<br>    <span class="hljs-function">QSqlQuery <span class="hljs-title">query</span><span class="hljs-params">(m_connect)</span></span>;<br>    QString sql = <span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;select * from person order by addtime desc&quot;</span>);<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">exec</span>(sql))<br>    &#123;<br>        <span class="hljs-keyword">while</span> (query.<span class="hljs-built_in">next</span>())<br>        &#123;<br>            DbViewItem item;<br>            item.id = query.<span class="hljs-built_in">value</span>(<span class="hljs-string">&quot;id&quot;</span>).<span class="hljs-built_in">toInt</span>();<br>            item.number = query.<span class="hljs-built_in">value</span>(<span class="hljs-string">&quot;number&quot;</span>).<span class="hljs-built_in">toString</span>();<br>            item.name = query.<span class="hljs-built_in">value</span>(<span class="hljs-string">&quot;name&quot;</span>).<span class="hljs-built_in">toString</span>();<br>            item.utype = query.<span class="hljs-built_in">value</span>(<span class="hljs-string">&quot;utype&quot;</span>).<span class="hljs-built_in">toInt</span>();<br>            item.addtime = query.<span class="hljs-built_in">value</span>(<span class="hljs-string">&quot;addtime&quot;</span>).<span class="hljs-built_in">toDateTime</span>();<br>            data.<span class="hljs-built_in">push_back</span>(item);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="./database/4.png" srcset="/img/loading.gif" lazyload alt="查询数据"></p><h4 id="多线程使用"><a href="#多线程使用" class="headerlink" title="多线程使用"></a>多线程使用</h4><p>如果在多线程中，为了保持单连接，要用到单例（设计模式这块儿后续有时间再缕），当然也可以一直做短连接，连接-&gt;执行-&gt;断开，不过一般不习惯这种操作，直接一个长连接保持就行。</p><p>在执行sql时进行锁操作，防止多个线程调用同一资源造成的冲突。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// .h</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br><span class="hljs-comment">// …省略其他</span><br><span class="hljs-keyword">private</span>:<br>    std::mutex lock_mutex;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CSqlLiteManager::insertData</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br>    lock_mutex.<span class="hljs-built_in">lock</span>(); <span class="hljs-comment">// 加锁</span><br>    QSqlQuery query;<br>    QString sql = <span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;insert into person (%1) values(&#x27;%2&#x27;,&#x27;%3&#x27;,%4,&#x27;%5&#x27;)&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;`number`,`name`,`utype`,`addtime`&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;100001&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-string">&quot;test01&quot;</span>)<br>        .<span class="hljs-built_in">arg</span>(<span class="hljs-number">1</span>)<br>        .<span class="hljs-built_in">arg</span>(QDateTime::<span class="hljs-built_in">currentDateTime</span>().<span class="hljs-built_in">toString</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br>    <span class="hljs-keyword">if</span> (query.<span class="hljs-built_in">exec</span>(sql))<br>    &#123;<br>        ret = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;insertData error: &quot;</span> &lt;&lt; query.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toStdString</span>() &lt;&lt; std::endl;<br>    &#125;<br>    lock_mutex.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 解锁</span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="多个数据库"><a href="#多个数据库" class="headerlink" title="多个数据库"></a>多个数据库</h4><p>有些业务比较复杂的，可能会用到多个/多类数据库，如本地sqllite，远程mysql之类的，在一个工程里如果使用多个数据库，要留意几个问题，一个是<strong>QSqlQuery</strong>的声明，另一个是<strong>QSqlDatabase::addDatabase()</strong> 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">m_connect = QSqlDatabase::<span class="hljs-built_in">addDatabase</span>(<span class="hljs-string">&quot;QSQLITE&quot;</span>,<span class="hljs-string">&quot;localdb&quot;</span>); <span class="hljs-comment">// 第二个参数是连接串名称，保持唯一</span><br><span class="hljs-function">QSqlQuery <span class="hljs-title">query</span><span class="hljs-params">(m_connect)</span></span>; <span class="hljs-comment">// 指定Query是用哪个连接</span><br></code></pre></td></tr></table></figure><div class="note note-warning"><p>相当于是谁的执行用谁的连接，不指定就按照默认的连接（也就是第一个连接），如果工程只有一个数据库连接那就不需要再这么麻烦，当然写上最好，毕竟规范嘛。</p></div><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>大体上数据库相关的操作基本上基础的就是这些，像分页啊查询条件啊聚合啊等等都是看看sql教程就行了，程序这块儿没有啥太多其他的操作，不过有些像数据绑定界面列表这种操作，因人而异吧，个人比较习惯自己写个结构体来接收然后自解析做绑定，后续有新的体会了会再更新调整。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%BC%96%E7%A8%8B/" class="category-chain-item">编程</a> <span>></span> <a href="/categories/%E7%BC%96%E7%A8%8B/qt/" class="category-chain-item">qt</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/qt/">#qt</a></div></div><div class="license-box my-3"><div class="license-title"><div>Qt 系列（七）——数据库</div><div>http://www.aprilblank.top/qt/database.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>AprilBlank</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年7月25日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/qt/form.html" title="Qt 系列（六）——表单"><span class="hidden-mobile">Qt 系列（六）——表单</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"s5z5TyRMaBchMy3ctLecCTVu-gzGzoHsz",appKey:"gDTvr3YyUBoiuEkLYjSdwggm",path:"window.location.pathname",placeholder:"说点儿啥吧",avatar:"retro",meta:["nick","mail","link"],requiredFields:["nick"],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><div class="copyright">©2016 - 2022 By AprilBlank</div><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">豫ICP备2022003971号</a></span></div></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", "))}))</script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/april-personal.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>